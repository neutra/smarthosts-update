// Generated by CoffeeScript 1.6.2
(function() {
  var FILE, URL, load, update;

  URL = "http://smarthosts.googlecode.com/svn/trunk/hosts";

  FILE = "c:/windows/system32/drivers/etc/hosts";

  load = function(callback) {
    var http, onConnect;

    http = require('http');
    onConnect = function(res) {
      var buffers, bytes;

      if (res.statusCode !== 200) {
        return callback("bad status: " + res.statusCode);
      }
      bytes = 0;
      buffers = [];
      res.on('data', function(buf) {
        buffers.push(buf);
        return bytes += buf.length;
      });
      return res.on('end', function() {
        var all, buf, i, _i, _len;

        all = "";
        if (bytes) {
          all = new Buffer(bytes);
          i = 0;
          for (_i = 0, _len = buffers.length; _i < _len; _i++) {
            buf = buffers[_i];
            buf.copy(all, i, 0, buf.length);
            i += buf.length;
          }
          all = all.toString('utf8');
        }
        all = all.replace(/127.0.0.1\tlocalhost\s*/, '');
        all = all.replace(/#SmartHosts START\s*/, '');
        all = all.replace(/\s*#SmartHosts END\s*/, '');
        all = '#SmartHosts AutoUpdate START\r\n\r\n' + all + '\r\n\r\n#SmartHosts AutoUpdate END\r\n';
        return callback(null, all);
      });
    };
    return http.get(URL, onConnect).on('error', callback);
  };

  update = function(text, callback) {
    var fs, old;

    fs = require('fs');
    old = fs.readFileSync(FILE, 'utf8');
    old = old.replace(/\s*#SmartHosts AutoUpdate START[\s\S]+#SmartHosts AutoUpdate END\s*/, '');
    fs.writeFileSync(FILE, old + '\r\n\r\n\r\n' + text);
    return callback(null);
  };

  (function() {
    return load(function(err, text) {
      if (err) {
        return console.log(err);
      }
      update(text, function(err) {});
      return console.log(err ? err : 'ok');
    });
  })();

}).call(this);
